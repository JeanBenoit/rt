%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2008 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<%ARGS>
$plugin => ''
$search => ''
$wipeout => ''
@wipeout_object => ()
</%ARGS>
<&| /Admin/Elements/Header, title => $title &>
<& /Elements/Tabs,
    current_tab => 'Admin/Tools/Shredder',
    current_subtab => 'Admin/Tools/Shredder',
    title => $title,
&>
<form id="shredder-search-form" action="<% RT->config->get('web_path') %>/Admin/Tools/Shredder/" method="GET">
<div id="shredder-select-plugin">
<& /Elements/ListActions, actions => $messages{'Errors'} &>
<& /Elements/ListActions, actions => $messages{'Success'} &>
<& Elements/DumpFileLink, file => $dump_file &>
<& Elements/SelectPlugin, plugin => $plugin, %ARGS &>
<div id="shredder-submit-button" class="<% $plugin? '': 'hidden' %>">
<& /Elements/Submit, name => 'search', label => _('Search') &>
</div>
</div>
<br />
% if( $search || $wipeout ) {
<& Elements/Selectobjects, objects => \@objs &>
% }
</form>
</&>
<%INIT>

require RT::Shredder;
my $title = _('Shredder');
my %messages = ( Errors => [], Success => [] );
my ($plugin_obj, @objs);

my $catch_non_fatals = sub  {
    require RT::Shredder::Exceptions;
    if ( my $e = RT::Shredder::Exception::Info->caught ) {
        push @{ $messages{Errors} }, "$e";
        $search = ''; @objs = ();
        return 1;
    }
    if ( UNIVERSAL::isa( $@, 'Class::Exception' ) ) {
        $@->rethrow;
    } else {
        die $@;
    }
};


if( $plugin ) { { # use additional block({}) to effectively exit block on errors
    use RT::Shredder::Plugin;
    $plugin_obj = new RT::Shredder::Plugin;
    my( $status, $msg ) = $plugin_obj->load_by_name( $plugin );
    unless( $status ) {
        push @{ $messages{Errors} }, $msg;
        $search = '';
        last;
    }

    my %args;
    foreach my $k( keys %ARGS ) {
        next unless $k =~ /^\Q$plugin\E:(.*)$/;
        $args{ $1 } = $ARGS{$k};
    }
    ( $status, $msg ) = $plugin_obj->has_support_for_args( keys %args );
    unless( $status ) {
        push @{ $messages{Errors} }, $msg;
        $search = '';
        last;
    }

    ($status, $msg) = eval { $plugin_obj->test_args( %args ) };
    $catch_non_fatals->() && last if $@;
    unless( $status ) {
        push @{ $messages{Errors} }, $msg;
        $search = '';
        last;
    }
} }

my $dump_file = '';

if( $plugin && $wipeout ) { { # use additional block({}) to effectively exit block on errors
    my $shredder = new RT::Shredder( force => 1 );
    my $backup_plugin = RT::Shredder::Plugin->new;
    my ($status, $msg) = $backup_plugin->load_by_name('SQLDump');
    unless( $status ) {
        push @{ $messages{Errors} }, $msg;
        $search = ''; @objs = ();
        last;
    }
    ($status, $msg) = $backup_plugin->test_args;

    unless( $status ) {
        push @{ $messages{Errors} }, $msg;
        $search = ''; @objs = ();
        last;
    }

    ($dump_file) = $backup_plugin->file_name;
    push @{ $messages{'Success'} }, "SQL dump file is '$dump_file'";

    $shredder->add_dump_plugin( object => $backup_plugin );

    $shredder->put_objects( objects => \@wipeout_object );
    ($status, $msg) = $plugin_obj->set_resolvers( Shredder => $shredder );
    unless( $status ) {
        push @{ $messages{Errors} }, $msg;
        $search = ''; @objs = ();
        last;
    }
    eval { $shredder->wipeout_all };

    $catch_non_fatals->() && last if $@;

    push @{ $messages{Success} }, _('objects were successfuly removed');

} }

if( $plugin && ( $search || $wipeout ) ) { { # use additional block({}) to effectively exit block on errors
    my $status;
    ($status, @objs) = eval { $plugin_obj->run };
    $catch_non_fatals->() && last if $@;
    unless( $status ) {
        push @{ $messages{Errors} }, $objs[0];
        $search = ''; @objs = ();
        last;
    }
    push @{ $messages{Success} }, _('executed plugin successfuly');

    my $shredder = new RT::Shredder;
    foreach my $o( grep defined, splice @objs ) {
        eval { push @objs, $shredder->cast_objectsToRecords( objects => $o ) };
          $catch_non_fatals->() && last if $@;
    }
    unless( @objs ) {
        push @{ $messages{Success} }, _('plugin returned empty list');
    } else {
        push @{ $messages{Success} }, _('see object list below');
    }
} }
</%INIT>
