%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2008 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<&| /_elements/wrapper, title=>_("Preferences") &>
<& /Elements/Tabs, 
    current_tab => 'User/Prefs.html', 
    title=>_("Preferences") &>

<& /Elements/ListActions, actions => \@results &>

<form action="<%RT->config->get('web_path')%>/User/Prefs.html" method="post">
<input type="hidden" class="hidden" name="id" value="<%$user_object->id%>" />

<table width="100%" border="0">
<tr>

<td valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => _('Identity'), id => "user-prefs-identity" &>

<input type="hidden" class="hidden" name="name" value="<%$user_object->name%>" />
<table cellspacing="0" cellpadding="0">
  <tr>
    <td class="label"><&|/l&>Email</&>: </td>
    <td class="value"><input name="email" value="<%$user_object->email%>" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Real name</&>:</td>
    <td class="value"><input name="real_name" value="<%$user_object->real_name%>" /></td>  </tr>
  <tr>
    <td class="label"><&|/l&>nickname</&>:</td>
    <td class="value"><input name="nickname" value="<%$user_object->nickname || ''%>" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Language</&>:</td>
    <td class="value"><& /Elements/SelectLang, name => 'lang', default => $user_object->lang &></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Time Zone</&>:</td>
    <td class="value"><& /Elements/SelectTimezone, name => 'time_zone', default => $user_object->time_zone &></td>
  </tr>
</table>
</&>
<&| /Widgets/TitleBox, title => _('Phone numbers'), id => "user-prefs-phone" &>
<table cellspacing="0" cellpadding="0">
  <tr>
    <td class="label"><&|/l&>Residence</&>:</td>
    <td class="value"><input name="home_phone" value="<%$user_object->home_phone || ''%>" size="13" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Work</&>:</td>
    <td class="value"><input name="work_phone" value="<%$user_object->work_phone || ''%>" size="13" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Mobile</&>:</td>
    <td class="value"><input name="mobile_phone" value="<%$user_object->mobile_phone || ''%>" size="13" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Pager</&>:</td>
    <td class="value"><input name="pager_phone" value="<%$user_object->pager_phone || ''%>" size="13" /></td>
  </tr>
</table>
</&>
% $m->callback( %ARGS, user_object => $user_object, callback_name => 'FormLeftColumn' );
</td>
<td valign="top" class="boxcontainer">
% unless (RT->config->get('web_external_auth') and !RT->config->get('web_fallback_to_internal_auth')) {
<&| /Widgets/TitleBox, title => _('password'), id => "user-prefs-password" &>
<table>
<tr>
<td class="label">
<&|/l&>New password</&>:
</td>
<td class="value">
<input type="password" name="pass1" autocomplete="off"/>
</td>
</tr>
<tr><td class="label">
<&|/l&>Retype password</&>:
</td>
<td class="value">
<input type="password" name="pass2" autocomplete="off" />
</td>
</tr>
</table>
</&>
% }

<&| /Widgets/TitleBox, title => _('Location'), id => "user-prefs-location" &>
<table cellspacing="0" cellpadding="0">
  <tr>
    <td class="label"><&|/l&>organization</&>:</td>
    <td class="value"><input name="organization" value="<%$user_object->organization || ''%>" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Address1</&>:</td>
    <td class="value"><input name="address1" value="<%$user_object->address1 || ''%>" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Address2</&>:</td>
    <td class="value"><input name="address2" value="<%$user_object->address2 || ''%>" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>City</&>:</td>
    <td><input name="city" value="<%$user_object->city || ''%>" size="14" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>State</&>:</td>
    <td class="value"><input name="state" value="<%$user_object->state || ''%>" size="3" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Zip</&>:</td>
    <td class="value"><input name="zip" value="<%$user_object->zip || ''%>" size="9" /></td>
  </tr>
  <tr>
    <td class="label"><&|/l&>Country</&>:</td>
    <td class="value"><input name="country" value="<%$user_object->country || ''%>" /></td>
  </tr>
</table>
</&>
% $m->callback( %ARGS, user_object => $user_object, callback_name => 'FormRightColumn' );
</td>
</tr>


<tr><td colspan="2" valign="top" class="boxcontainer">
%if ($user_object->privileged) {
<br />
<&| /Widgets/TitleBox, title => _('Signature') &>
<textarea cols="80" rows="5" name="signature" class="signature" wrap="hard">
<%$user_object->signature || ''%></textarea>
</&>
% }
</td></tr>

<tr><td colspan="2" valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => _('Secret authentication token'), id => "user-prefs-feeds" &>

<&|/l&><p>All iCal feeds embed a secret token which authorizes you.  If the URL one of your iCal feeds got exposed to the outside world, you can get a new secret, <b>breaking all existing iCal feeds</b> below.</p></&>

<& /Elements/Submit, label => _('Reset secret authentication token'), name => "reset_auth_token" &>
</&>
</td></tr>

</table>

% $m->callback( %ARGS, user_object => $user_object, callback_name => 'FormEnd' );

<& /Elements/Submit, label => _('Save Preferences') &>
</form>


</&>
<%INIT>

my $user_object = RT::Model::User->new( current_user => Jifty->web->current_user );
my ($title, $privilegedChecked, $enabled_checked, $disabled, $result, @results);

my ($val, $msg);


	$user_object->load($id) || $user_object->load($name) || abort("Couldn't load user '$name'");
	$val = $user_object->id();
    





# If we have a user to modify, lets try. 
if ($user_object->id) {
    
    my @fields = qw(name comments Signature email freeform_contact_info 
		    organization real_name nickname lang email_encoding web_encoding 
		    ExternalContactInfoId ContactInfoSystem gecos ExternalAuthId 
		    auth_system HomePhone WorkPhone MobilePhone PagerPhone Address1
		Address2 City State Zip Country lang time_zone
		   );

    $m->callback(
        callback_name => 'UpdateLogic',
        fields       => \@fields,
        results      => \@results,
        user_object      => $user_object,
        args_ref      => \%ARGS,
    );
    
    my @fieldresults = update_record_object ( attributes_ref => \@fields,
					    object => $user_object,
					    args_ref => \%ARGS );
    push (@results,@fieldresults);


# Deal with special fields: privileged, enabled, and Password
if  ( ($set_privileged) and ( $privileged != $user_object->privileged) ) {
my  ($code, $msg) = $user_object->set_privileged($privileged);
     push @results, _('privileged status: %1', _($msg));
}

#TODO: make this report errors properly
if ((defined $pass1) and ($pass1 ne '') and ($pass1 eq $pass2) and (!$user_object->password_is($pass1))) {
    my ($code, $msg);
    ($code, $msg) = $user_object->set_password($pass1);
    push @results, _('password: %1', _($msg));
} elsif ( $pass1 && ($pass1 ne $pass2)) {
    push @results, _("passwords do not match. Your password has not been changed");
}

    if ( $ARGS{'reset_auth_token'} ) {
        my ($status, $msg) = $user_object->generate_auth_token;
        push @results, $msg;
    }
}


</%INIT>


<%ARGS>
$id => Jifty->web->current_user->id
$name  => undef
$comments  => undef
$signature  => undef
$email  => undef
$freeform_contact_info => undef
$organization  => undef
$real_name  => undef
$nickname  => undef
$privileged => undef
$set_privileged => undef
$enabled => undef
$set_enabled => undef
$lang  => undef
$email_encoding  => undef
$web_encoding => undef
$external_contact_info_id  => undef
$contact_info_system  => undef
$gecos => undef
$external_auth_id  => undef
$auth_system  => undef
$home_phone => undef
$work_phone  => undef
$mobile_phone  => undef
$pager_phone  => undef
$address1 => undef
$address2  => undef
$city  => undef
$state  => undef
$zip  => undef
$country => undef
$pass1 => undef
$pass2=> undef
$create=> undef
</%ARGS>
