%# BEGIN BPS TAGGED BLOCK {{{
%# 
%# COPYRIGHT:
%# 
%# This software is Copyright (c) 1996-2008 Best Practical Solutions, LLC
%#                                          <jesse@bestpractical.com>
%# 
%# (Except where explicitly superseded by other copyright notices)
%# 
%# 
%# LICENSE:
%# 
%# This work is made available to you under the terms of Version 2 of
%# the GNU General Public License. A copy of that license should have
%# been provided with this software, but in any event can be snarfed
%# from www.gnu.org.
%# 
%# This work is distributed in the hope that it will be useful, but
%# WITHOUT ANY WARRANTY; without even the implied warranty of
%# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
%# General Public License for more details.
%# 
%# You should have received a copy of the GNU General Public License
%# along with this program; if not, write to the Free Software
%# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
%# 02110-1301 or visit their web page on the internet at
%# http://www.gnu.org/licenses/old-licenses/gpl-2.0.html.
%# 
%# 
%# CONTRIBUTION SUBMISSION POLICY:
%# 
%# (The following paragraph is not intended to limit the rights granted
%# to you to modify and distribute this software under the terms of
%# the GNU General Public License and is only of importance to you if
%# you choose to contribute your changes and enhancements to the
%# community by submitting them to Best Practical Solutions, LLC.)
%# 
%# By intentionally submitting any modifications, corrections or
%# derivatives to this work, or any other work intended for use with
%# Request Tracker, to Best Practical Solutions, LLC, you confirm that
%# you are the copyright holder for those contributions and you grant
%# Best Practical Solutions,  LLC a nonexclusive, worldwide, irrevocable,
%# royalty-free, perpetual, license to use, copy, create derivative
%# works based on those contributions, and sublicense and distribute
%# those contributions and any derivatives thereof.
%# 
%# END BPS TAGGED BLOCK }}}
<&| /_elements/wrapper, title => $title &>
<& /Elements/Tabs,
    current_subtab => $current_subtab,
    title => $title,
    dashboard_obj => $dashboard_obj &>

<& /Elements/ListActions, actions => \@results &>

<form action="<%RT->config->get('web_path')%>/Dashboards/Subscription.html" method="post" enctype="multipart/form-data" name="subscribe_dashboard">
<input type="hidden" class="hidden" name="dashboard_id" value="<% $fields{'dashboard_id'} %>" />
<table width="100%" border="0">
<tr>

<td valign="top" class="boxcontainer">
<&| /Widgets/TitleBox, title => _('Dashboard') &>

<table>
<tr><td class="label">
<&|/l&>Dashboard</&>:
</td><td class="value">
<% $dashboard_obj->name %>
</td></tr>

<tr><td class="label">
<&|/l&>Queries</&>:
</td><td class="value">
% my @portlets = grep { defined } $dashboard_obj->portlets;
% if (!@portlets) {
(<&|/l&>none</&>)
% } else {
<ol class="dashboard-queries">
%    for my $portlet (@portlets) {
        <li class="dashboard-query">
            <% _($portlet->{description}, $fields{'rows'}) %>
        </li>
%    }
</ol>
% }
</td></tr>

</table>
</&>

<&| /Widgets/TitleBox, title => _('Subscription') &>

<table>
<tr><td class="label">
<&|/l&>Frequency</&>:
</td><td class="value">
<input type="radio" name="frequency" value="daily" <% $fields{'frequency'} eq
'daily' ? 'checked="checked"' : "" |n %> />
    <&|/l&>daily</&>
<br />
<input type="radio" name="frequency" value="weekly"<% $fields{'frequency'} eq
'weekly' ? 'checked="checked"' : "" |n %> />
<&|/l&>weekly</&>, <&|/l&>on</&>
<select name="dow">
    <option value="Monday" <% $fields{'dow'} eq 'Monday' ? 'selected="selected"' : '' %>><&|/l&>Monday</&></option>
    <option value="Tuesday" <% $fields{'dow'} eq 'Tuesday' ? 'selected="selected"' : '' %>><&|/l&>Tuesday</&></option>
    <option value="Wednesday" <% $fields{'dow'} eq 'Wednesday' ? 'selected="selected"' : '' %>><&|/l&>Wednesday</&></option>
    <option value="Thursday" <% $fields{'dow'} eq 'Thursday' ? 'selected="selected"' : '' %>><&|/l&>Thursday</&></option>
    <option value="Friday" <% $fields{'dow'} eq 'Friday' ? 'selected="selected"' : '' %>><&|/l&>Friday</&></option>
    <option value="Saturday" <% $fields{'dow'} eq 'Saturday' ? 'selected="selected"' : '' %>><&|/l&>Saturday</&></option>
    <option value="Sunday" <% $fields{'dow'} eq 'Sunday' ? 'selected="selected"' : '' %>><&|/l&>Sunday</&></option>
</select>
<&|/l&>weeks</&>
<select name="fow">
% for my $f ( qw/1 2 3 4/ ) {
    <option value="<%$f%>" <% $fields{'fow'} == $f ? 'selected="selected"' : '' %>><% $f %></option>
% }
<br />
</select>

<input type="radio" name="frequency" value="monthly"<% $fields{'frequency'} eq
'monthly' ? 'checked="checked"' : "" |n %>/>
<&|/l&>monthly</&>, <&|/l&>on day</&>
<select name="dom">
%   for my $dom (1..31) {
    <option value="<% $dom %>" <% $fields{'dom'} == $dom ?
'selected="selected"' : '' |n %>><% _($dom) %></option>
%   }
</select>
<br />

<input type="radio" name="frequency" value="never" <% $fields{'frequency'} eq
'never' ? 'checked="checked"' : "" |n%> />
    <&|/l&>never</&>
</td></tr>
<tr><td class="label">
<&|/l&>Hour</&>:
</td><td class="value">
<select name="hour">
% for my $hour (0..23) {
%     my $formatted = sprintf '%02d:00', $hour;
%     my $selected = $formatted eq $fields{'hour'}
%                  ? 'selected="selected"'
%                  : '';

    <option value="<% $formatted %>" <%$selected%>><% $formatted %></option>
% }
</select>
(in <%$timezone%>)
</td></tr>
<tr><td class="label">
<&|/l&>Rows</&>:
</td><td class="value">
<select name="rows">
%   for my $rows (1, 2, 5, 10, 15, 20, 25, 50, 75, 100, 0) {
    <option value="<% $rows %>" <% $fields{'rows'} eq $rows ? 'selected="selected"' : '' %>><% _($rows || 'Unlimited') %></option>
%   }
</select>
</td></tr>

<tr><td class="label">
<&|/l&>Recipient</&>:
</td><td class="value">
<input name="Recipient" id="Recipient" size="30" value="<%$fields{Recipient} ? $fields{Recipient} : ''%>" />
<div class="hints"><% _("Leave blank to send to your current email address (%1)", Jifty->web->current_user->user_object->email) %></div>
</td></tr>
</table>
</&>
</td>
</tr>
</table>

% if ($SubscriptionObj->id) {
    <& /Elements/Submit, name => "save", label => _('Save Changes') &>
% } else {
    <& /Elements/Submit, name => "save", label => _('Subscribe') &>
% }
</form>

</&>
<%INIT>

my $current_subtab = 'Dashboards/Subscription.html?dashboard_id=' . $dashboard_id;

my ($title, @results);
my ($val, $msg);
my $Loaded = 0;
my $timezone = Jifty->web->current_user->user_object->time_zone || RT->config->get('time_zone');

use RT::Dashboard;
my $dashboard_obj = RT::Dashboard->new( current_user => Jifty->web->current_user );

my $SubscriptionObj = RT::Model::Attribute->new( current_user => Jifty->web->current_user );

# first let's see if we already have a subscription to this dashboard_id
for my $sub (Jifty->web->current_user->user_object->attributes->named('Subscription')) {
    next unless $sub->sub_value('dashboard_id') == $dashboard_id;
    $SubscriptionObj = $sub;
    last;
}

$dashboard_id = $SubscriptionObj->id
             ? $SubscriptionObj->sub_value('dashboard_id')
             : $ARGS{'dashboard_id'};

($val, $msg) = $dashboard_obj->load_by_id($dashboard_id);
$val || abort(_("Couldn't load dashboard %1: %2.", $dashboard_id, $msg));

my %fields = (
    dashboard_id => $dashboard_id,
    frequency   => 'daily',
    hour        => '06:00',
    dow         => 'Monday',
    dom         => 1,
    rows        => 20,
    recipient   => '',
    fow         => 1,
    counter     => 0,
);

# update any fields with the values from the subscription object
if ($SubscriptionObj->id) {
    for my $field (keys %fields) {
        $fields{$field} = $SubscriptionObj->sub_value($field);
    }
}

# finally, update any fields with arguments passed in by the user
for my $field (keys %fields) {
    next if $field eq 'dashboard_id'; # but this one is immutable
    $fields{$field} = $ARGS{$field}
        if defined($ARGS{$field});
}
# this'll be defined on submit
if (defined $ARGS{save}) {
    # update
    if ($SubscriptionObj->id) {
        $dashboard_id = delete $fields{'dashboard_id'}; # immutable
        ($val, $msg) = $SubscriptionObj->set_sub_values(%fields);
        $fields{'dashboard_id'} = $dashboard_id;

        # not so good to spew base64-encoded data at the user :)
        if ($msg =~ /^Content changed from/) {
            $msg = "Subscription updated.";
        }

        push @results, $msg;
    }
    # create
    else {
        abort(_("Unable to subscribe to dashboard %1: Permission denied", $dashboard_id))
            unless $dashboard_obj->current_user_can_subscribe;

        my ($val, $msg) = $SubscriptionObj->create(
            name        => 'Subscription',
            description => 'Subscription to dashboard ' . $dashboard_id,
            content_type => 'storable',
            object      => Jifty->web->current_user->user_object,
            content     => \%fields,
        );
        if ($val) {
            push @results, _("Subscribed to dashboard %1", $dashboard_obj->name);
            push @results, _("Warning: you have no email address set, so you will not receive this dashboard until you have it set")
                unless Jifty->web->current_user->email || $fields{recipient};
        }
        else {
            push @results, _('Subscription could not be created: %1', $msg);
        }
    }
}

if ($SubscriptionObj->id) {
    $title = _("Modify the subscription to dashboard %1", $dashboard_obj->name);
}
else {
    $title = _("Subscribe to dashboard %1", $dashboard_obj->name);
}

</%INIT>
<%ARGS>
$dashboard_id => undef
$frequency   => undef
$hour        => undef
$dow         => undef
$dom         => undef
$rows        => undef
$recipient   => undef
</%ARGS>

